#
# Makefile to rebuild the swig wrapper and/or samples under Linux, RHEL 4.x.
#

# ----------------------------------------------
# Tools: Edit as required for your installation.
# ----------------------------------------------

# Installed JDK version.
jdk_ver = jdk1.5.0_15

# And location.
java_home = /usr/java/$(jdk_ver)

# The java compiler to user.
javac = $(java_home)/bin/javac

# The java include directories for compiling JNI libraries.
javac_incs = $(java_home)/include $(java_home)/include/linux

# The jar command to use.
jar = $(java_home)/bin/jar

# The compiler to use.
cxx = g++ -O2 -fPIC

# The SWIG executable to use. Note that version 4.0.1 is recommended to support python 3.
swig = /devopt/swig-4.0.1/bin/swig

# -----------
# Definitions
# -----------

# The JNI wrapper library.
wrapper = ../lib/libSWAPILink.so

# The sample applications.
dealer_example = java_dealer_example.jar
dealsink_example = java_dealsink_example.jar
samples = $(dealer_example) $(dealsink_example)

# 'make' builds everything.
all: $(wrapper) $(samples)

# 'make wrapper' builds the wrapper library.
wrapper: $(wrapper)

# 'make samples' builds both samples.
samples: $(samples)

# -----------
# JNI Wrapper
# -----------

# The directory where the sources for $(wrapper) live.
wrapper_dir = com/swapswire/sw_api

# The source file generated by swig to make $(wrapper).
wrapper_src = \
  $(wrapper_dir)/sw_api_swig.cpp \
  $(wrapper_dir)/jnitools.cpp


# The file that $(wrapper_src) is generated from.
wrapper_swig_src = $(wrapper_dir)/sw_api_swig.i

# The rule to make $(wrapper_swig_src).
$(wrapper_dir)/sw_api_swig.cpp: $(wrapper_swig_src)
	$(swig) -java -c++ -package com.swapswire.sw_api -I$(wrapper_dir) -I../sw_api_inc -outdir $(wrapper_dir) -o $@ $<

# The rule to make $(wrapper)
$(wrapper): $(wrapper_src)
	$(cxx) $^ -I.. $(javac_incs:%=-I%) -I../sw_api_inc -L../lib -lsw_api -shared -o $@

# ------------
# Java Samples
# ------------

# Sample application directories.
dealer_example_dir = com/swapswire/dealerexample
dealsink_example_dir = com/swapswire/dealsinkexample

# The samples depend on the wrapper and the .java files being compiled
$(dealer_example): $(wrapper) $(dealer_example_dir)/DealerExample.class
	$(jar) cvfm $(dealer_example) $(dealer_example_dir)/manifest.txt $(dealer_example_dir)/*.class $(wrapper_dir)/*.class

$(dealsink_example): $(wrapper) $(dealsink_example_dir)/DealSinkExample.class
	$(jar) cvfm $(dealsink_example) $(dealsink_example_dir)/manifest.txt $(dealsink_example_dir)/*.class $(wrapper_dir)/*.class

# Rules to compile the java files
$(dealsink_example_dir)/DealSinkExample.class: $(dealsink_example_dir)/DealSinkExample.java
	$(javac) $<

$(dealer_example_dir)/DealerExample.class: $(dealer_example_dir)/DealerExample.java
	$(javac) $<

# 'make clean' removes the generated output
clean:
	rm -f $(wrapper) $(samples) $(dealer_example_dir)/*.class $(dealsink_example_dir)/*.class $(wrapper_dir)/sw_api_swig.cpp $(wrapper_dir)/*.class $(wrapper_dir)/*.java

